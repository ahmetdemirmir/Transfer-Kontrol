<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Demir Kƒ±rtasiye - Kamera Barkod Okuma ve Etiket</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<style>
  body {
    font-family: 'Roboto', sans-serif;
    background: #f5f7fa;
    margin:0; padding:0;
    display:flex;
    flex-direction: column;
    align-items: center;
  }
  header {
    background:#fff;
    width: 100%;
    padding: 20px 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  header img { height: 56px; }
  .container {
    width: 97%;
    max-width: 700px;
    margin-top: 12px;
    background:#fff;
    padding: 20px 10px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.07);
  }
  .top-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-bottom: 10px;
  }
  .btn {
    background: #468be6;
    color: white;
    border:none;
    padding: 10px 19px;
    font-size: 17px;
    font-weight: bold;
    border-radius: 9px;
    cursor:pointer;
    user-select:none;
    transition: background 0.14s;
    min-width: 140px;
    box-shadow: 0 2px 6px #e8eaf6;
    outline: none;
  }
  .btn:active, .btn:focus { background: #3472b9; }
  .btn.csv { background: #ffd700; color: #222; }
  .btn.manual { background: #469ce6; }
  .upload-section { display:none; }
  .camera-bar { display: flex; gap: 10px; justify-content: center; margin: 13px 0;}
  .camera-bar button {
    background: #24b85b;
    color: white;
    border: none;
    padding: 9px 13px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 15px;
    cursor: pointer;
  }
  .camera-bar button:active { background: #17833e; }
  #camera-preview {
    width: 100%;
    max-width: 680px;
    height: 310px;
    border: 2px solid #ccc;
    border-radius: 14px;
    margin-bottom: 15px;
    background: black;
    position: relative;
  }
  #camera-preview video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
  }
  #manual-barcode {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    margin-bottom: 11px;
    border: 1px solid #ccc;
    border-radius: 8px;
    text-align: center;
    background: #fafafd;
  }
  #manual-barcode[disabled] {
    background:#eee;
    color:#666;
  }
  #log {
    font-weight: bold;
    margin-top: 4px;
    text-align: center;
    color: #456;
    font-size: 15px;
  }
  #scanned-list {
    max-height: 100px;
    overflow-y: auto;
    margin-top: 8px;
    border: 1px solid #ddd;
    border-radius: 7px;
    padding: 8px;
    background: #f9f9f9;
  }
  #scanned-list li {
    margin: 5px 0;
    font-weight: 600;
    font-size: 15px;
  }
  .popup {
    display: none;
    position: fixed;
    top:0; left:0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.38);
    justify-content: center;
    align-items: center;
    z-index: 99;
  }
  .popup-content {
    background: #2ecc71;
    color: #fff;
    padding: 16px 20px;
    border-radius: 16px;
    max-width: 360px;
    width: 96vw;
    min-width: 200px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.14);
    text-align: center;
    font-weight: bold;
    position: relative;
    animation: popIn 0.25s;
  }
  .popup-content.error { background: #e74c3c; }
  @keyframes popIn {
    from { transform:scale(0.92); opacity: 0.3;}
    to { transform:scale(1); opacity:1; }
  }
  .popup-content h2 {
    font-size: 20px;
    margin: 8px 0 6px 0;
  }
  .popup-content p {
    font-size: 16px;
    margin: 6px 0 4px 0;
  }
  #product-price {
    font-size: 44px;
    color: #e60000;
    font-weight: 900;
    margin: 7px 0 2px 0;
    letter-spacing: 1px;
  }
  #product-date {
    font-size: 21px;
    color: #5a0000;
    font-weight: 700;
    margin: 8px 0 8px 0;
  }
  .qty-options {
    display: flex;
    gap: 6px;
    justify-content: center;
    margin-bottom: 12px;
  }
  .qty-btn {
    background: #eaeaea;
    color: #222;
    border: none;
    padding: 10px 19px;
    border-radius: 8px;
    font-size: 17px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
  }
  .qty-btn.selected, .qty-btn:active {
    background: #4a90e2;
    color: #fff;
  }
  .qty-btn.big {
    font-size: 28px;
    background: #e60000;
    color: #fff;
    min-width: 55px;
    height: 46px;
  }
  .qty-custom-input {
    width: 48px;
    font-size: 18px;
    text-align: center;
    margin-left: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  .btn-green {
    background: linear-gradient(90deg, #ff8800 20%, #ffd966 100%);
    color: #222;
    border: none;
    padding: 16px 34px;
    font-size: 21px;
    font-weight: bold;
    border-radius: 10px;
    cursor: pointer;
    margin: 18px 8px 0 0;
    box-shadow: 0 4px 8px rgba(255,136,0,0.08);
    letter-spacing: 1px;
    transition: box-shadow 0.18s;
  }
  .btn-green:hover {
    box-shadow: 0 6px 12px rgba(255,136,0,0.19);
    background: linear-gradient(90deg, #ffd966 20%, #ff8800 100%);
  }
  .btn-red {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 12px 27px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    margin: 10px 0 0 5px;
    border: 2px solid #e74c3c;
    transition: box-shadow 0.16s, background 0.12s;
  }
  .btn-red.outline {
    background: #fff;
    color: #e74c3c;
    border: 2px solid #e74c3c;
    box-shadow: 0 0 0 2px #fff, 0 2px 8px rgba(231,76,60,0.09);
  }
  .btn-red.outline:hover {
    background: #fceaea;
  }
  .btn-red.outline { box-shadow: 0 0 0 3px #fff, 0 2px 8px #e74c3c22; }
  .btn-red:active { background: #b91e1e; }
  .popup-content .btn-green { margin-bottom: 10px; }
  .checkbox {
    margin-top: 11px;
    font-size: 16px;
    font-weight: 400;
    color: #fff;
  }
  /* Responsive tweaks */
  @media (max-width: 600px) {
    .top-buttons { flex-direction: column; align-items: stretch; gap: 7px;}
    .container { padding: 11px 2px;}
    .camera-bar { flex-direction: column; gap:7px;}
    .popup-content { max-width: 97vw; font-size: 15px; padding: 10px 2vw;}
    #camera-preview { height: 210px; }
    #product-price { font-size: 30px;}
    #product-date { font-size: 17px;}
  }
</style>
</head>
<body onload="init()">
<header>
  <img src="LOGO.png" alt="Demir Kƒ±rtasiye Logo" />
</header>
<div class="container">
  <div class="top-buttons">
    <button class="btn" onclick="fetchCSV()">üîÑ Verileri Otomatik Al</button>
    <label for="csvUpload" class="btn csv">üìÅ CSV Y√ºkle</label>
    <input type="file" id="csvUpload" accept=".csv" style="display:none;" />
    <button class="btn manual" onclick="openManualSearch()">üîç Manuel √úr√ºn Ara</button>
  </div>
  <div style="font-size:18px; text-align:center; margin-bottom:7px;">
    CSV dosyanƒ±zƒ± buradan y√ºkleyin veya Google Sheets ile verileri √ßekin
  </div>
  <div style="font-size:16px; color:#222; text-align:center; margin-bottom:10px;">
    <span id="update-date">Son G√ºncellenme Tarihi: -</span>
  </div>
  <div class="camera-bar">
    <button onclick="toggleCamera()">Kamera A√ß/Kapat</button>
    <button onclick="switchCamera()">√ñn/Arka Kamera Deƒüi≈ütir</button>
    <button onclick="toggleManualEntry()">Manuel Barkod Giri≈üi</button>
  </div>
  <div id="camera-preview"></div>
  <input type="text" id="manual-barcode" placeholder="üì• Barkod okutun veya yazƒ±n" onkeypress="if(event.key==='Enter'){searchBarcode()}" />
  <div id="log"></div>
  <ul id="scanned-list"></ul>
</div>

<!-- Popup -->
<div class="popup" id="popup">
  <div class="popup-content" id="popupContent">
    <h2 id="product-name">√úR√úN ADI</h2>
    <p id="product-barcode">Barkod: </p>
    <p id="product-price">Fiyat: 0,00 ‚Ç∫</p>
    <p id="product-date">Fiyat Deƒüi≈üiklik Tarihi:</p>
    <div id="label-controls">
      <p>Ka√ß adet etiket basƒ±lsƒ±n?</p>
      <div class="qty-options" id="qtyOptions">
        <button class="qty-btn big selected" onclick="selectQty(1)">1</button>
        <button class="qty-btn" onclick="selectQty(2)">2</button>
        <button class="qty-btn" onclick="selectQty(3)">3</button>
        <button class="qty-btn" id="qtyCustomBtn" onclick="selectQty('custom')">Adet</button>
        <input type="number" min="1" max="99" id="qtyCustomInput" class="qty-custom-input" style="display:none;" value="1" oninput="selectQty('custom')" />
      </div>
      <label class="checkbox"><input type="checkbox" id="campaignCheck" /> Kampanyalƒ±</label><br />
      <button class="btn-green" onclick="confirmLabel()">‚úî Tamam</button>
      <button class="btn-red" onclick="closePopup()">‚úñ ƒ∞ptal</button>
    </div>
    <div id="error-controls" style="display:none;">
      <button class="btn-red outline" onclick="closePopup()">‚úñ Kapat</button>
    </div>
  </div>
</div>

<!-- Manuel Arama Popup -->
<div class="popup" id="manualSearchPopup" style="z-index:101;">
  <div class="popup-content" style="max-width:410px;">
    <h2>üîç √úr√ºn Ara</h2>
    <input id="manualSearchInput" type="text" style="font-size:20px;width:98%;margin:7px 0 7px 0;padding:7px;text-align:center;border-radius:7px;border:1px solid #bbb;" placeholder="Barkodun son 6 hanesi veya isim yaz" oninput="manualSearchFilter()" autofocus />
    <ul id="manualSearchResult" style="max-height:290px;overflow-y:auto;margin:0;padding:0;"></ul>
    <div id="manualSearchNoResult" style="display:none; color:#c22;font-size:17px;font-weight:bold;margin-top:7px;">Sonu√ß bulunamadƒ±.</div>
    <button class="btn-red outline" style="margin-top:13px;" onclick="closeManualSearch()">Kapat</button>
  </div>
</div>

<!-- Ses dosyalarƒ± -->
<audio id="beep-sound" src="beep.mp3"></audio>
<audio id="error-sound" src="error.mp3"></audio>

<script>
// -- Ayarlar --
const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQAL1Sv9G-ZRLj7-ukvYOugaSBMscgoIM7Hvo3iLqmwVNKQYmHZhRY0-K3rimSvVw/pub?output=csv";

let excelData = [];
let selectedProduct = null;
let cameraActive = false;
let currentCamera = 'environment';
let quaggaRunning = false;
let selectedQty = 1;

const manualInput = document.getElementById('manual-barcode');
const cameraPreview = document.getElementById('camera-preview');
const scannedList = document.getElementById('scanned-list');

// -- Tarih T√ºrk√ßele≈ütirici
function formatDateTR(input) {
  if (!input) return "";
  if (typeof input === "string" && input.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/)) {
    let parts = input.split("/");
    if (parts.length === 3) {
      let ay = parts[0].padStart(2, "0");
      let gun = parts[1].padStart(2, "0");
      let yil = parts[2].length === 2 ? "20" + parts[2] : parts[2];
      // ABD formatƒ± ise: ay/g√ºn/yƒ±l -> g√ºn.ay.yƒ±l
      return `${gun}.${ay}.${yil}`;
    }
  }
  if (typeof input === "string" && input.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
    return input;
  }
  return input;
}

// --- CSV Dosyasƒ± Y√ºkleme
document.getElementById("csvUpload").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    parseCSV(event.target.result);
    document.getElementById('update-date').innerText = "Son G√ºncellenme Tarihi: Dosya Y√ºklendi";
  };
  reader.readAsText(file, "utf-8");
});

// --- Google Sheets'ten CSV √ßekme
function fetchCSV() {
  fetch(sheetCSV)
    .then(res => res.text())
    .then(csv => {
      parseCSV(csv);
      // Son g√ºncelleme tarihi i√ßin sheets'ten veri √ßekilemiyor; "otomatik" yazalƒ±m
      document.getElementById('update-date').innerText = "Son G√ºncellenme Tarihi: Otomatik";
    })
    .catch(() => alert("CSV verisi alƒ±namadƒ±!"));
}

// --- CSV PARSER (virg√ºl ve nokta hatasƒ±na dayanƒ±klƒ±)
function parseCSV(csv) {
  let rows = csv.replace(/\r\n/g, '\n').split('\n');
  let headers = rows[0].split(';').length > rows[0].split(',').length ?
    rows[0].split(';') : rows[0].split(',');
  excelData = rows.slice(1).map(row => {
    let cells = row.split(headers.length > 8 ? ';' : ',');
    let obj = {};
    headers.forEach((h, i) => obj[h.trim()] = (cells[i]||"").trim());
    // Tarih ve fiyat d√ºzenlemesi:
    obj["Fiyat Deƒüi≈üiklik Tarihi"] = formatDateTR(obj["Fiyat Deƒüi≈üiklik Tarihi"] || obj["Satƒ±≈ü Fiyatƒ± 1 Deƒü. Tar."] || obj["F"]);
    obj["MAƒûAZA"] = formatPrice(obj["MAƒûAZA"]);
    return obj;
  }).filter(e => e["Barkodu"]); // Barkodu olmayan satƒ±rlarƒ± at
}

// --- Fiyatƒ± T√ºrk√ße formatla
function formatPrice(val) {
  if (!val) return "";
  let num = String(val).replace(",", ".").replace(/[^\d.]/g, "");
  let parsed = parseFloat(num);
  if (isNaN(parsed)) return val;
  let fiyat = parsed.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  // 12,00 => 12 veya 12,5 => 12,50
  if (fiyat.endsWith(",00")) return fiyat.slice(0, -3);
  return fiyat;
}

// -- Kamera B√∂l√ºm√º (QuaggaJS)
function init() {
  disableManualInput(false);
  if(!cameraActive) manualInput.focus();
}
function toggleCamera() {
  if(cameraActive) stopCamera(); else startCamera();
}
function switchCamera() {
  currentCamera = (currentCamera === 'environment') ? 'user' : 'environment';
  if(cameraActive) { stopCamera(); setTimeout(startCamera, 350);}
}
function disableManualInput(disabled) {
  manualInput.disabled = disabled;
  if(!disabled && !cameraActive && document.getElementById("popup").style.display === "none") manualInput.focus();
}
function toggleManualEntry() {
  if(manualInput.disabled) { disableManualInput(false); stopCamera(); manualInput.focus(); }
  else { disableManualInput(true); startCamera(); }
}
function startCamera() {
  if(quaggaRunning) return;
  Quagga.init({
    inputStream: {
      type : "LiveStream",
      constraints: { facingMode: currentCamera },
      target: cameraPreview
    },
    decoder: { readers: ["ean_reader","code_128_reader"] }
  }, function(err) {
    if(err) { logMessage("Kamera a√ßƒ±lamadƒ± veya izin verilmedi."); return; }
    Quagga.start(); quaggaRunning = true; cameraActive = true; disableManualInput(true);
    logMessage("Kamera a√ßƒ±k. Barkod okutun...");
  });
  Quagga.onDetected(onBarcodeDetected);
}
function stopCamera() {
  if(!quaggaRunning) return;
  Quagga.stop(); quaggaRunning = false; cameraActive = false;
  disableManualInput(false); logMessage("Kamera kapandƒ±.");
}
function onBarcodeDetected(data) {
  let code = data.codeResult.code;
  if(!code) return;
  Quagga.offDetected(onBarcodeDetected);
  let found = excelData.find(item => String(item["Barkodu"]) === code);
  playBeep(!!found); vibrateDevice(); logMessage(`Barkod okundu: ${code}`); addToScannedList(code);
  if(found) showPopup(found); else showErrorPopup(code);
  setTimeout(() => { Quagga.onDetected(onBarcodeDetected); }, 1750);
}

// -- Barkod i≈ülemleri
function searchBarcode() {
  let code = manualInput.value.trim();
  if(!code) return;
  let found = excelData.find(item => String(item["Barkodu"]) === code);
  if(found) { showPopup(found); manualInput.value = ""; }
  else showErrorPopup(code);
  if(!cameraActive) manualInput.focus();
}
function addToScannedList(code) {
  let li = document.createElement('li'); li.textContent = code; scannedList.appendChild(li);
}
function playBeep(success = true) {
  let beep = document.getElementById(success ? 'beep-sound' : 'error-sound');
  if(beep) beep.play();
}
function vibrateDevice() { if(navigator.vibrate) navigator.vibrate(160); }

// -- Popup & Label
function selectQty(qty) {
  document.querySelectorAll('.qty-btn').forEach(btn => btn.classList.remove('selected'));
  if (qty === 'custom') {
    document.getElementById('qtyCustomBtn').classList.add('selected');
    document.getElementById('qtyCustomInput').style.display = 'inline-block';
    selectedQty = parseInt(document.getElementById('qtyCustomInput').value) || 1;
  } else {
    selectedQty = qty;
    document.getElementById('qtyCustomInput').style.display = 'none';
    document.querySelectorAll('.qty-btn')[qty-1].classList.add('selected');
    document.getElementById('qtyCustomInput').value = qty;
  }
}
function confirmLabel() { document.getElementById("popup").style.display = "none"; if(!cameraActive) manualInput.focus(); }
function showPopup(product) {
  selectedProduct = product;
  const popupContent = document.getElementById("popupContent");
  popupContent.classList.remove("error");
  document.getElementById("product-name").innerText = product["Stok Adƒ±"];
  document.getElementById("product-barcode").innerText = `Barkod: ${product["Barkodu"]}`;
  document.getElementById("product-price").innerText = `Fiyat: ${product["MAƒûAZA"]} ‚Ç∫`;
  document.getElementById("product-date").innerText = `Fiyat Deƒüi≈üiklik Tarihi: ${formatDateTR(product["Fiyat Deƒüi≈üiklik Tarihi"]) || "Bilinmiyor"}`;
  selectQty(1);
  document.getElementById("label-controls").style.display = "block";
  document.getElementById("error-controls").style.display = "none";
  document.getElementById("popup").style.display = "flex";
}
function showErrorPopup(code) {
  const popupContent = document.getElementById("popupContent");
  popupContent.classList.add("error");
  document.getElementById("product-name").innerText = "√úr√ºn Bulunamadƒ±!";
  document.getElementById("product-barcode").innerText = `Barkod: ${code}`;
  document.getElementById("product-price").innerText = "";
  document.getElementById("product-date").innerText = "";
  document.getElementById("label-controls").style.display = "none";
  document.getElementById("error-controls").style.display = "block";
  document.getElementById("popup").style.display = "flex"; manualInput.value = "";
}
function closePopup() { document.getElementById("popup").style.display = "none"; if(!cameraActive) manualInput.focus(); }
function logMessage(msg) { document.getElementById('log').innerText = msg; }

// -- Manuel √úr√ºn Arama Popup
function openManualSearch() {
  document.getElementById("manualSearchPopup").style.display = "flex";
  document.getElementById("manualSearchInput").value = "";
  manualSearchFilter();
  setTimeout(()=>document.getElementById("manualSearchInput").focus(),150);
}
function closeManualSearch() { document.getElementById("manualSearchPopup").style.display = "none"; }
function manualSearchFilter() {
  let q = document.getElementById("manualSearchInput").value.toLowerCase();
  let ul = document.getElementById("manualSearchResult");
  let nores = document.getElementById("manualSearchNoResult");
  ul.innerHTML = "";
  let results = excelData.filter(row =>
    (row["Barkodu"] && row["Barkodu"].toLowerCase().includes(q)) ||
    (row["Stok Adƒ±"] && row["Stok Adƒ±"].toLowerCase().includes(q))
  );
  if (q.length < 2 || results.length == 0) {
    nores.style.display = "block"; return;
  } else nores.style.display = "none";
  results.slice(0,12).forEach(row => {
    let li = document.createElement("li");
    li.style.padding = "6px";
    li.style.cursor = "pointer";
    li.style.textAlign = "left";
    li.style.borderBottom = "1px solid #eee";
    li.innerHTML = `<b>${row["Barkodu"]}</b> - <span>${row["Stok Adƒ±"]}</span>`;
    li.onclick = ()=>{ closeManualSearch(); showPopup(row); };
    ul.appendChild(li);
  });
}

</script>
</body>
</html>
