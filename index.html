<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Demir Kƒ±rtasiye - Kamera Barkod Okuma & Raf Etiketi</title>
<meta name="viewport" content="width=900, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body {
  background: #f6f6f8;
  font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
  margin: 0; padding: 0;
  display: flex; flex-direction: column; align-items: center;
}
header {background:#fff; width: 100%; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:center;}
header img { height: 60px; }
.container {width: 95%; max-width: 700px; margin-top: 20px; background:#fff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
.upload-section {text-align:center; padding: 20px; border: 2px dashed #ccc; border-radius: 12px; margin-bottom: 20px; background: #fafafa; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center;}
input[type=file] { display:none;}
.btn { background: #4a90e2; color: white; border:none; padding: 10px 20px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor:pointer; user-select:none;}
.btn:hover { background: #357abd;}
#manual-barcode { width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; text-align: center;}
#manual-barcode[disabled] { background:#ddd; color:#666;}
#camera-controls { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; flex-wrap: wrap;}
#camera-controls button { background: #27ae60; color: white; border: none; padding: 8px 15px; font-weight: bold; border-radius: 8px; cursor: pointer;}
#camera-controls button:hover { background: #1e8449;}
#camera-preview { width: 100%; max-width: 680px; height: 400px; border: 2px solid #ccc; border-radius: 12px; margin-bottom: 15px; background: black; position: relative;}
#camera-preview video { width: 100%; height: 100%; object-fit: cover; border-radius: 12px;}
#log { font-weight: bold; margin-top: 10px; text-align: center;}
#scanned-list { max-height: 120px; overflow-y: auto; margin-top: 10px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; background: #f9f9f9;}
#scanned-list li { margin: 5px 0; font-weight: 600;}
/* Etiket sepeti */
#etiket-sepeti-bolum { margin: 0 0 24px 0; }
#etiket-sepeti-list { list-style: none; padding: 0; margin: 0 0 8px 0;}
#etiket-sepeti-list li { margin: 7px 0; padding: 3px 8px; background: #f8f8fb; border-radius: 8px; font-size:15px; display:flex; align-items:center; justify-content:space-between;}
.sepet-kaldir-btn { font-size:13px; background:#e74c3c; color:#fff; border:none; border-radius:8px; padding:2px 8px; cursor:pointer;}
.sepet-temizle-btn { font-size:14px; background:#4a90e2; color:#fff; border:none; border-radius:8px; padding:4px 12px; cursor:pointer; margin-bottom: 8px;}
.sepet-temizle-btn:hover, .sepet-kaldir-btn:hover { background:#bd2637; }
#etiket-yazdir-btn { font-size: 22px; padding: 11px 50px; background:#2196f3;color:#fff;border-radius:12px;border:none;cursor:pointer;letter-spacing:4px; margin-top:10px;}
#etiket-yazdir-btn:disabled { background: #b0bec5; cursor: not-allowed; }
/* Popup ve animasyon */
.popup { display: none; position: fixed; top:0; left:0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.34); justify-content: center; align-items: center; z-index: 999;}
.popup-content { background: #2ecc71; color: #fff; padding: 20px 30px; border-radius: 12px; max-width: 360px; width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: center; font-weight: bold; position: relative;}
.popup-content.loading { background: #4a90e2; color: #fff; font-size: 20px; font-weight: 700;}
.popup-content.error { background: #e74c3c;}
.popup-content h2 { font-size: 18px; margin: 8px 0;}
.popup-content p { font-size: 16px; margin: 6px 0;}
/* Etiket YATAY */
.etiket {
  background: #fff;
  width: 300px;
  height: 120px;
  border-radius: 18px;
  box-shadow: 0 2px 10px #d7d7db77;
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  padding: 18px 18px 12px 8px;
  box-sizing: border-box;
  position: relative;
}
.etiket-logo {
  width: 73px;
  height: 95px;
  margin-right: 6px;
  margin-top: 0;
  flex-shrink: 0;
  display: flex;
  align-items: flex-start;
  justify-content: flex-start;
}
.etiket-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.etiket-icerik {
  flex: 1;
  display: flex; flex-direction: column;
  justify-content: space-between;
  height: 100%;
}
.etiket-stokadi {
  font-size: 12px;
  font-weight: 500;
  color: #2e2e2e;
  margin-bottom: 1px;
  line-height: 1.15;
  min-height: 45px;
  word-break: break-word;
  max-height: 38px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.etiket-row {
  display: flex;
  align-items: flex-end;
  justify-content: flex-end;
  gap: 6px;
  margin-top: 6px;
}
.etiket-fiyat {
  font-size: 30px;
  color: #e20032;
  font-weight: 650;
  letter-spacing: 1.5px;
  margin: 0;
  display: flex;
  align-items: flex-end;
  gap: 2px;
  min-width: 62px;
  justify-content: flex-end;
}
.etiket-fiyat .tlsimge {
  font-size: 17px;
  margin-left: 2px;
}
.etiket-barkod {
  width: 72px;
  height: 34px;
  margin-bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  z-index: 1;
  pointer-events: auto;
  margin-left: 0;
}
.etiket-barkod img {
  width: 100%;
  height: 38px;
  object-fit: contain;
  margin-left: 0;
}
@media (max-width: 700px) {
  .container {padding: 6px; margin-top: 8px;}
  .upload-section {flex-direction: column; gap: 8px;}
  .btn {width: 100%; min-width: unset;}
  #camera-controls {flex-direction: column; gap: 8px;}
  #camera-preview {height: 250px;}
  .popup-content {max-width: 98vw !important;width: 99vw !important;min-height: 200px;top: 10px !important;left: 0 !important;position: fixed !important;transform: none !important;border-radius: 18px !important;margin: 0 auto;font-size: 15.5px;}
  #manualSearchPopup .popup-content { top: 12px !important; }
}
</style>
</head>
<body onload="init()">
<header>
  <img src="LOGO.png" alt="Demir Kƒ±rtasiye Logo" />
</header>
<div class="container">
  <div class="upload-section">
    <button class="btn" onclick="fetchSheetData()">üîÑ Verileri Otomatik Al</button>
    <label for="excelUpload" class="btn">üìÇ Excel Y√ºkle (Manuel)</label>
    <input type="file" id="excelUpload" accept=".csv,.xlsx,.xls" />
    <button class="btn" onclick="openManualSearch()">üîç Manuel √úr√ºn Ara</button>
    <p style="width:100%;margin-bottom:0;">Excel dosyanƒ±zƒ± buradan y√ºkleyin veya verileri √ßekin</p>
    <div id="lastUpdate" style="font-size:15px; margin-top:8px; color:#444; width:100%;"></div>
  </div>

  <div id="camera-controls">
    <button id="btnToggleCamera" onclick="toggleCamera()">Kamera A√ß/Kapat</button>
    <button id="btnSwitchCamera" onclick="switchCamera()">√ñn/Arka Kamera Deƒüi≈ütir</button>
    <button id="btnManualEntry" onclick="toggleManualEntry()">Manuel Barkod Giri≈üi</button>
  </div>

  <div id="camera-preview"></div>

  <input
    type="text"
    id="manual-barcode"
    placeholder="üì• Barkod okutun veya yazƒ±n"
    onkeypress="if(event.key==='Enter'){searchBarcode()}"
  />

  <div id="log"></div>
  <ul id="scanned-list"></ul>

  <!-- Etiket Sepeti B√∂l√ºm√º -->
  <div id="etiket-sepeti-bolum" style="margin-top:30px;">
    <h3>Etiket Sepeti</h3>
    <ul id="etiket-sepeti-list"></ul>
    <button class="sepet-temizle-btn" onclick="sepetiTemizle()">Sepeti Temizle</button>
    <button id="etiket-yazdir-btn" onclick="etiketleriYazdir()" disabled>Etiket Yazdƒ±r (PDF)</button>
  </div>
</div>

<!-- Y√ºkleniyor Popup -->
<div class="popup" id="loadingPopup">
  <div class="popup-content loading" id="loadingPopupContent">
    <span id="loadingText">Veriler y√ºkleniyor...</span>
    <br><br>
    <span id="lastUpdateInfo"></span>
  </div>
</div>

<!-- Manuel √úr√ºn Arama Popup -->
<div class="popup" id="manualSearchPopup">
  <div class="popup-content" style="max-width:420px; width:96%;">
    <span style="position:absolute;top:10px;right:18px;font-size:22px;cursor:pointer;" onclick="closeManualSearch()">&times;</span>
    <h2 style="margin-top:0;">√úr√ºn Bul / Barkod Ara</h2>
    <input type="text" id="searchInput" placeholder="Son 6 rakam veya √ºr√ºn adƒ±" oninput="filterManualSearch()" style="width:90%;font-size:18px;padding:10px;margin-bottom:15px;border-radius:8px;border:1px solid #ccc;text-align:center;">
    <ul id="manualSearchResults" style="list-style:none;padding:0;max-height:210px;overflow-y:auto;margin:0;"></ul>
    <div id="noResultText" style="display:none;color:#c00;font-weight:bold;margin-top:8px;">√úr√ºn bulunamadƒ±!</div>
  </div>
</div>

<!-- √úr√ºn Popup -->
<div class="popup" id="popup">
  <div class="popup-content" id="popupContent">
    <h2 id="product-name">√úR√úN ADI</h2>
    <p id="product-barcode">Barkod: </p>
    <p id="product-price">Fiyat: 0,00 ‚Ç∫</p>
    <div id="label-controls">
      <p>Ka√ß adet etiket basƒ±lsƒ±n?</p>
      <div class="qty-options" id="qtyOptions">
        <button class="qty-btn big selected" onclick="selectQty(1)">1</button>
        <button class="qty-btn" onclick="selectQty(2)">2</button>
        <button class="qty-btn" onclick="selectQty(3)">3</button>
        <button class="qty-btn" id="qtyCustomBtn" onclick="selectQty('custom')">Adet</button>
        <input type="number" min="1" max="99" id="qtyCustomInput" class="qty-custom-input" style="display:none;" value="1" oninput="selectQty('custom')" />
      </div>
      <button class="btn-green" onclick="confirmLabel()">Etiket Yazdƒ±r</button>
      <button class="btn-red" onclick="closePopup()">ƒ∞ptal</button>
    </div>
    <div id="error-controls" style="display:none;">
      <button class="btn-red outline" onclick="closePopup()">‚úñ Kapat</button>
    </div>
  </div>
</div>

<!-- Ses dosyalarƒ± -->
<audio id="beep-sound" src="beep.mp3" preload="auto"></audio>
<audio id="error-sound" src="error.mp3" preload="auto"></audio>
<audio id="repeat-sound" src="error.mp3" preload="auto"></audio> <!-- Aynƒ± √ºr√ºne uyarƒ± i√ßin -->

<!-- ETIKET TEMPLATE! (YAZDIR/PDF i√ßin) -->
<div id="etiketler" style="display:none"></div>

<script>
// --- CSV / EXCEL PARSE
function parseCSVRow(row) {
  const regex = /(?:,|\n|^)(?:"([^"]*(?:""[^"]*)*)"|([^",\n]*))/g;
  let matches, cells = [];
  while ((matches = regex.exec(row))) {
    cells.push(matches[1] !== undefined ? matches[1].replace(/""/g, '"') : matches[2]);
  }
  return cells;
}
function parseCSV(text) {
  return text.split('\n').map(parseCSVRow);
}
let excelData = [];
let selectedProduct = null;
let cameraActive = false;
let currentCamera = 'environment';
let quaggaRunning = false;
let selectedQty = 1;

// SEPET LOGIC
let etiketSepeti = []; // {barkod, stokadi, fiyat, adet}

function updateEtiketSepetiList() {
  const list = document.getElementById("etiket-sepeti-list");
  list.innerHTML = "";
  etiketSepeti.forEach((etiket, i) => {
    let li = document.createElement("li");
    li.innerHTML = `<span><b>${etiket.barkod}</b> - ${etiket.stokadi} <span style="color:#1b81d2; font-weight:600">x${etiket.adet}</span></span>
      <button class="sepet-kaldir-btn" onclick="etiketKaldir(${i})">Kaldƒ±r</button>`;
    list.appendChild(li);
  });
  document.getElementById("etiket-yazdir-btn").disabled = etiketSepeti.length === 0;
}
function etiketKaldir(idx) {
  etiketSepeti.splice(idx,1);
  updateEtiketSepetiList();
}
function sepetiTemizle() {
  if(confirm("Sepeti tamamen temizlemek istediƒüine emin misin?")) {
    etiketSepeti = [];
    updateEtiketSepetiList();
  }
}

// CSV Y√úKLEME & SHEET'TEN √áEKME
const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQAL1Sv9G-ZRLj7-ukvY0ugaSBMscgoiM7Hvo3iLqmwVNKQYmHZhRY0-K3rimSvVw/pub?output=csv";
function fetchSheetData() {
  showLoadingPopup(true, "");
  fetch(sheetCSV)
    .then(response => {
      if (!response.ok) throw new Error("Google Sheets baƒülantƒ± hatasƒ±!");
      const now = new Date();
      const gunler = ['Pazar','Pazartesi','Salƒ±','√áar≈üamba','Per≈üembe','Cuma','Cumartesi'];
      const gun = gunler[now.getDay()];
      const tarih = now.toLocaleDateString("tr-TR") + " " + gun;
      document.getElementById('lastUpdate').innerHTML = "Son G√ºncellenme Tarihi: <b>" + tarih + "</b>";
      showLoadingPopup(true, tarih);
      return response.text();
    })
    .then(csvText => {
      const rows = parseCSV(csvText);
      const headers = rows[0];
      const dataRows = rows.slice(1).filter(row => row[0]);
      const priceChangeDateHeader = "Satƒ±≈ü Fiyatƒ± 1 Deƒü. Tar.";
      const priceChangeDateIndex = headers.findIndex(h => h && h.trim() === priceChangeDateHeader);

      excelData = dataRows.map(row => {
        let obj = {};
        headers.forEach((h, i) => obj[h] = row[i]);
        obj["MAƒûAZA"] = cleanPrice(obj["MAƒûAZA"]);
        obj["Fiyat Deƒüi≈üiklik Tarihi"] = cleanDate(row[priceChangeDateIndex]);
        return obj;
      });
      logMessage(`‚úÖ ${excelData.length} √ºr√ºn Google Sheets'den y√ºklendi!`);
      showLoadingPopup(false);
    })
    .catch(e => {
      showLoadingPopup(false);
      alert("Google Sheets verileri alƒ±namadƒ±!\n" + e);
    });
}
const excelInput = document.getElementById("excelUpload");
excelInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(event) {
    let text = event.target.result;
    if (file.name.endsWith(".xlsx") || file.name.endsWith(".xls")) {
      if (window.XLSX) {
        let data = new Uint8Array(event.target.result);
        let workbook = XLSX.read(data, { type: "array" });
        let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        let csv = XLSX.utils.sheet_to_csv(firstSheet);
        text = csv;
      } else {
        alert("Excel dosyasƒ± i√ßin SheetJS k√ºt√ºphanesi eksik!");
        return;
      }
    }
    const rows = parseCSV(text);
    const headers = rows[0];
    const dataRows = rows.slice(1);
    const priceChangeDateHeader = "Satƒ±≈ü Fiyatƒ± 1 Deƒü. Tar.";
    const priceChangeDateIndex = headers.findIndex(h => h && h.trim() === priceChangeDateHeader);

    excelData = dataRows.map((row) => {
      let obj = {};
      headers.forEach((h, i) => (obj[h] = row[i]));
      obj["MAƒûAZA"] = cleanPrice(obj["MAƒûAZA"]);
      obj["Fiyat Deƒüi≈üiklik Tarihi"] = cleanDate(row[priceChangeDateIndex]);
      return obj;
    });
    logMessage(`‚úÖ ${excelData.length} √ºr√ºn Excel/CSV ile y√ºklendi.`);
  };
  if (file.name.endsWith(".xlsx") || file.name.endsWith(".xls")) {
    reader.readAsArrayBuffer(file);
  } else {
    reader.readAsText(file, "UTF-8");
  }
});

// Fƒ∞YAT ve TARƒ∞H TEMƒ∞ZLEYƒ∞Cƒ∞
function cleanPrice(str) {
  if (!str) return "";
  str = String(str).replace(/"/g, '').replace(/[^\d,\.]/g, '');
  let match = str.match(/\d+[.,]?\d*/);
  return match ? match[0].replace('.', ',') : "";
}
function cleanDate(val) {
  if (!val) return "Bilinmiyor";
  val = String(val).replace(/"/g, '').replace(/[^0-9./-]/g, '');
  if (val.match(/^\d{4}-\d{2}-\d{2}$/)) {
    let [yil, ay, gun] = val.split("-");
    return `${gun}/${ay}/${yil}`;
  }
  if (val.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
    let [ay, gun, yil] = val.split("/");
    if (parseInt(gun) > 12) return `${gun}/${ay}/${yil}`;
    if (parseInt(ay) > 12) return `${ay}/${gun}/${yil}`;
    return `${gun}/${ay}/${yil}`;
  }
  return val.length > 1 ? val.replace(/-/g, "/").replace(/\./g, "/") : "Bilinmiyor";
}

// MANUEL √úR√úN ARAMA
function openManualSearch() {
  document.getElementById('manualSearchPopup').style.display = 'flex';
  document.getElementById('searchInput').value = '';
  filterManualSearch();
  setTimeout(() => {
    const input = document.getElementById('searchInput');
    input.focus();
    if (window.innerWidth < 700) {
      document.querySelector('#manualSearchPopup .popup-content').style.top = '10px';
    }
  }, 250);
}
function closeManualSearch() {
  document.getElementById('manualSearchPopup').style.display = 'none';
}
function filterManualSearch() {
  let val = document.getElementById('searchInput').value.trim().toLowerCase();
  let resultList = document.getElementById('manualSearchResults');
  resultList.innerHTML = '';
  let noResult = document.getElementById('noResultText');
  let filtered = excelData.filter(item => {
    let barkod = String(item["Barkodu"] || "").toLowerCase();
    let ad = String(item["Stok Adƒ±"] || "").toLowerCase();
    return (
      (!val || barkod.includes(val) || ad.includes(val)) ||
      (val.length === 6 && barkod.endsWith(val))
    );
  });
  if(filtered.length === 0) {
    noResult.style.display = 'block';
    return;
  }
  noResult.style.display = 'none';
  filtered.slice(0,12).forEach(item => {
    let li = document.createElement('li');
    li.innerHTML = `<span style="font-size:17px;font-weight:bold">${item["Barkodu"]}</span> - <span style="font-size:16px">${item["Stok Adƒ±"]}</span>`;
    li.style.cursor = "pointer";
    li.style.padding = "9px 6px";
    li.style.borderBottom = "1px solid #eee";
    li.addEventListener('click', () => {
      closeManualSearch();
      document.activeElement.blur();
      setTimeout(() => showPopup(item), 100);
    });
    resultList.appendChild(li);
  });
}
document.addEventListener('mousedown', function(e){
  let popup = document.getElementById('manualSearchPopup');
  if (popup && popup.style.display === "flex") {
    if (!popup.querySelector('.popup-content').contains(e.target)) {
      closeManualSearch();
    }
  }
});

// --- Loading Popup
function showLoadingPopup(show, tarih="") {
  let pop = document.getElementById('loadingPopup');
  if(show) {
    pop.style.display = 'flex';
    document.getElementById('lastUpdateInfo').innerText = tarih ? `Son g√ºncelleme: ${tarih}` : "";
  } else {
    pop.style.display = 'none';
  }
}

// KAMERA BARKOD OKUMA
function init() {
  manualInput.addEventListener('click', () => { manualInput.focus(); });
  disableManualInput(false);
  if(!cameraActive) { manualInput.focus(); }
  if (typeof XLSX === "undefined") {
    var script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
    document.head.appendChild(script);
  }
}
const manualInput = document.getElementById('manual-barcode');
const cameraPreview = document.getElementById('camera-preview');
const scannedList = document.getElementById('scanned-list');

function disableManualInput(disabled) {
  manualInput.disabled = disabled;
  if(!disabled && !cameraActive && document.getElementById("popup").style.display === "none") {
    manualInput.focus();
  }
}
function toggleManualEntry() {
  if(manualInput.disabled) {
    disableManualInput(false);
    stopCamera();
    manualInput.focus();
  } else {
    disableManualInput(true);
    startCamera();
  }
}
function toggleCamera() {
  if(cameraActive) { stopCamera(); } else { startCamera(); }
}
function switchCamera() {
  if(currentCamera === 'environment') { currentCamera = 'user'; } else { currentCamera = 'environment'; }
  if(cameraActive) { stopCamera(); startCamera(); }
}
function startCamera() {
  if(quaggaRunning) return;
  Quagga.init({
    inputStream: {
      type : "LiveStream",
      constraints: { facingMode: currentCamera },
      target: cameraPreview
    },
    decoder: { readers: ["ean_reader","code_128_reader"] }
  }, function(err) {
    if(err) { logMessage("Kamera a√ßƒ±lamadƒ± veya izin verilmedi."); return; }
    Quagga.start();
    quaggaRunning = true; cameraActive = true; disableManualInput(true); logMessage("Kamera a√ßƒ±k. Barkod okutun...");
  });
  Quagga.onDetected(onBarcodeDetected);
}
function stopCamera() {
  if(!quaggaRunning) return;
  Quagga.stop(); quaggaRunning = false; cameraActive = false; disableManualInput(false); logMessage("Kamera kapandƒ±.");
}
function onBarcodeDetected(data) {
  let code = data.codeResult.code;
  if(!code) return;
  Quagga.offDetected(onBarcodeDetected);

  let found = excelData.find(item => String(item["Barkodu"]) === code);
  playBeep(!!found);
  vibrateDevice();

  logMessage(`Barkod okundu: ${code}`);
  addToScannedList(code);

  if(found) { showPopup(found); }
  else { showErrorPopup(code); }
  setTimeout(() => { Quagga.onDetected(onBarcodeDetected); }, 2000);
}
function addToScannedList(code) {
  let li = document.createElement('li');
  li.textContent = code;
  scannedList.appendChild(li);
}
function playBeep(success = true) {
  let audio = document.getElementById(success ? "beep-sound" : "error-sound");
  if(audio) { audio.currentTime = 0; audio.play(); }
}
function vibrateDevice() {
  if(navigator.vibrate) { navigator.vibrate(200); }
}

function searchBarcode() {
  let code = manualInput.value.trim();
  if(code === "") return;
  let found = excelData.find(item => String(item["Barkodu"]) === code);
  if(found) {
    showPopup(found);
    manualInput.value = "";
  } else {
    showErrorPopup(code);
  }
  if(!cameraActive) manualInput.focus();
}
function selectQty(qty) {
  document.querySelectorAll('.qty-btn').forEach(btn => btn.classList.remove('selected'));
  if (qty === 'custom') {
    document.getElementById('qtyCustomBtn').classList.add('selected');
    document.getElementById('qtyCustomInput').style.display = 'inline-block';
    selectedQty = parseInt(document.getElementById('qtyCustomInput').value) || 1;
  } else {
    selectedQty = qty;
    document.getElementById('qtyCustomInput').style.display = 'none';
    document.querySelectorAll('.qty-btn')[qty-1].classList.add('selected');
    document.getElementById('qtyCustomInput').value = qty;
  }
}

// --- ETƒ∞KET SEPETƒ∞NE EKLE
function confirmLabel() {
  let qty = selectedQty;
  if(document.getElementById('qtyCustomBtn').classList.contains('selected')) {
    qty = parseInt(document.getElementById('qtyCustomInput').value) || 1;
  }
  // --- Zaten var mƒ±? ---
  let barkod = selectedProduct["Barkodu"];
  let idx = etiketSepeti.findIndex(e => e.barkod == barkod);
  if(idx !== -1) {
    // √úr√ºn zaten eklendiyse √ºst√ºne ekleme promptu
    let onay = confirm("Zaten ekli, √ºst√ºne adet eklemek ister misin?");
    playBeep(false); // repeat-sound (error) uyarƒ±sƒ±
    if(onay) {
      etiketSepeti[idx].adet += qty;
      playBeep(true);
    }
  } else {
    etiketSepeti.push({
      barkod: barkod,
      stokadi: selectedProduct["Stok Adƒ±"],
      fiyat: selectedProduct["MAƒûAZA"],
      adet: qty
    });
    playBeep(true);
  }
  updateEtiketSepetiList();
  closePopup();
  selectedQty = 1;
  document.getElementById('qtyCustomInput').value = "1";
}
// --- ETƒ∞KET YAZDIR / PDF OLU≈ûTUR
function etiketleriYazdir() {
  if(etiketSepeti.length === 0) return;
  // jsPDF ile her etiketi 4x6 cm (300x120px gibi) olarak yatay diz
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: "landscape",
    unit: "mm",
    format: [60, 40] // 60mm x 40mm -> 6x4cm
  });
  let addEtiketToPDF = function({barkod, stokadi, fiyat}, idx, isFirst) {
    doc.setFillColor(255,255,255);
    doc.rect(0,0,60,40,"F");
    // Logo (sol √ºst)
    doc.addImage("logo.png", "PNG", 2, 3, 15, 25);
    // Stok adƒ± (√ºstte, 2 satƒ±ra yay)
    doc.setFont("helvetica", "normal"); doc.setFontSize(7.5);
    let lines = doc.splitTextToSize(stokadi, 35); // 2 satƒ±ra b√∂l
    doc.text(lines, 19, 9);
    // Fiyat (saƒüda)
    doc.setFont("helvetica", "bold"); doc.setFontSize(15);
    doc.setTextColor(226, 0, 50);
    doc.text(fiyat + " ‚Ç∫", 50, 20, { align: "right" });
    // Barkod g√∂rseli
    let barkodImg = document.createElement("img");
    barkodImg.crossOrigin = "Anonymous";
    barkodImg.src = "https://barcodeapi.org/api/ean13/" + barkod;
    barkodImg.onload = function() {
      let canvas = document.createElement("canvas");
      canvas.width = 240; canvas.height = 60;
      let ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,240,60);
      ctx.drawImage(barkodImg, 0, 0, 240, 60);
      let url = canvas.toDataURL("image/png");
      doc.addImage(url, "PNG", 32, 22, 26, 11);
      // Eƒüer son etiketse veya bu sayfa son etiketse kaydet
      if(idx === etiketSepeti.length-1) {
        doc.save("etiketler.pdf");
      } else {
        doc.addPage([60,40],"landscape");
      }
    };
  };
  etiketSepeti.forEach((etiket,i) => {
    for(let k=0;k<etiket.adet;k++) {
      addEtiketToPDF(etiket, i, k==0);
    }
  });
}
// -------------------- POPUP & LOGIC --------------------
function showPopup(product) {
  selectedProduct = product;
  const popupContent = document.getElementById("popupContent");
  popupContent.classList.remove("error");
  document.getElementById("product-name").innerText = product["Stok Adƒ±"];
  document.getElementById("product-barcode").innerText = `Barkod: ${product["Barkodu"]}`;
  document.getElementById("product-price").innerText = `Fiyat: ${product["MAƒûAZA"]} ‚Ç∫`;
  selectQty(1);
  document.getElementById("label-controls").style.display = "block";
  document.getElementById("error-controls").style.display = "none";
  document.getElementById("popup").style.display = "flex";
}
function showErrorPopup(code) {
  const popupContent = document.getElementById("popupContent");
  popupContent.classList.add("error");
  document.getElementById("product-name").innerText = "√úr√ºn Bulunamadƒ±!";
  document.getElementById("product-barcode").innerText = `Barkod: ${code}`;
  document.getElementById("product-price").innerText = "";
  document.getElementById("label-controls").style.display = "none";
  document.getElementById("error-controls").style.display = "block";
  manualInput.value = "";
}
function closePopup() {
  document.getElementById("popup").style.display = "none";
  if(!cameraActive) manualInput.focus();
}
function logMessage(msg) {
  document.getElementById('log').innerText = msg;
}
</script>
</body>
</html>
